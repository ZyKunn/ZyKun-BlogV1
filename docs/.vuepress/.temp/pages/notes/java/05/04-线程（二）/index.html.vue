<template><div><h1 id="_04-çº¿ç¨‹-äºŒ" tabindex="-1"><a class="header-anchor" href="#_04-çº¿ç¨‹-äºŒ" aria-hidden="true">#</a> 04 - çº¿ç¨‹ï¼ˆäºŒï¼‰ ğŸ˜»</h1>
<nav class="table-of-contents"><ul><li><router-link to="#çº¿ç¨‹å¹¶å‘é—®é¢˜">çº¿ç¨‹å¹¶å‘é—®é¢˜</router-link><ul><li><router-link to="#æ¦‚è¿°">æ¦‚è¿°</router-link></li><li><router-link to="#æ¡ˆä¾‹åœºæ™¯">æ¡ˆä¾‹åœºæ™¯</router-link></li><li><router-link to="#å¹¶å‘ç¼–ç¨‹æœ‰ä¸‰è¦ç´ ">å¹¶å‘ç¼–ç¨‹æœ‰ä¸‰è¦ç´ </router-link></li></ul></li><li><router-link to="#çº¿ç¨‹åŒæ­¥è§£å†³æ–¹æ¡ˆ">çº¿ç¨‹åŒæ­¥è§£å†³æ–¹æ¡ˆ</router-link><ul><li><router-link to="#synchronized">Synchronized</router-link></li><li><router-link to="#lock">lock</router-link></li><li><router-link to="#volatile">volatile</router-link></li></ul></li><li><router-link to="#ä½œä¸š">ä½œä¸š</router-link></li></ul></nav>
<h2 id="çº¿ç¨‹å¹¶å‘é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹å¹¶å‘é—®é¢˜" aria-hidden="true">#</a> çº¿ç¨‹å¹¶å‘é—®é¢˜</h2>
<h3 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h3>
<p>åœ¨å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡æ—¶å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š</p>
<p>ä¾‹å¦‚ï¼šé“¶è¡Œå–é’±ï¼Œç°æœ‰å¤šä¸ªç”¨æˆ·æ“ä½œåŒä¸€ä¸ªè´¦æˆ·ï¼Œå¯èƒ½ä¼šé‡åˆ°å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œå‡è®¾ä¸€ä¸ªè´¦æˆ·ä¸­ä½™é¢ä¸€å…± 10000 å…ƒï¼Œç°åœ¨æœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶é€šè¿‡è¯¥è´¦æˆ·å–æ¬¾ï¼Œå„å– 10000ï¼›å–æ¬¾çš„è¿‡ç¨‹å¿…ç„¶ä¼šå…ˆè¿›è¡Œä½™é¢æ£€æŸ¥ï¼Œå¦‚æœä½™é¢è¶³å¤Ÿåˆ™å…è®¸å–æ¬¾ï¼›å¦‚æœå¤šä¸ªç”¨æˆ·å°†å–æ¬¾çš„æ—¶é—´æ°å¥½å®šåœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œæ­¤æ—¶å°±å¯èƒ½å‡ºç°è¿™äº›ç”¨æˆ·åŒæ—¶å–æ¬¾æˆåŠŸçš„æƒ…å†µï¼Œä½†æ˜¯å®é™…è´¦æˆ·çš„ä½™é¢ä¸é¢„æœŸçš„ç»“æœå‡ºç°ä¸ä¸€è‡´ã€‚</p>
<p>ä»¥ä¸Šé—®é¢˜å°±ç§°ä¹‹ä¸º<strong>çº¿ç¨‹å®‰å…¨</strong>é—®é¢˜ï¼›æ‰€è°“çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼šå³å¤šçº¿ç¨‹å¹¶å‘æ“ä½œå…±äº«å˜é‡æ—¶é€ æˆçš„ç»“æœæ±¡æŸ“é—®é¢˜</p>
<h3 id="æ¡ˆä¾‹åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹åœºæ™¯" aria-hidden="true">#</a> æ¡ˆä¾‹åœºæ™¯</h3>
<p>ç±»ä¼¼ä»¥ä¸Šçº¿ç¨‹å®‰å…¨é—®é¢˜æœ‰å¾ˆå¤šï¼š</p>
<ul>
<li>è´­ç¥¨</li>
<li>é™æ—¶ç§’æ€</li>
</ul>
<h3 id="å¹¶å‘ç¼–ç¨‹æœ‰ä¸‰è¦ç´ " tabindex="-1"><a class="header-anchor" href="#å¹¶å‘ç¼–ç¨‹æœ‰ä¸‰è¦ç´ " aria-hidden="true">#</a> å¹¶å‘ç¼–ç¨‹æœ‰ä¸‰è¦ç´ </h3>
<ul>
<li>åŸå­æ€§ï¼šçº¿ç¨‹æ˜¯åŸå­æ“ä½œçš„ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥</li>
<li>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ“ä½œæ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹è¦å®æ—¶çš„åŒæ­¥åˆ°å…¶ä»–çº¿ç¨‹ä¸­</li>
<li>æœ‰åºæ€§ï¼šçº¿ç¨‹å†…éƒ¨çš„ç¨‹åºæ‰§è¡Œï¼Œç”±ä¸Šè€Œä¸‹ä¾æ¬¡æ‰§è¡Œã€‚(é¿å…æŒ‡ä»¤é‡æ’)</li>
</ul>
<h2 id="çº¿ç¨‹åŒæ­¥è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹åŒæ­¥è§£å†³æ–¹æ¡ˆ" aria-hidden="true">#</a> çº¿ç¨‹åŒæ­¥è§£å†³æ–¹æ¡ˆ</h2>
<h3 id="synchronized" tabindex="-1"><a class="header-anchor" href="#synchronized" aria-hidden="true">#</a> Synchronized</h3>
<p>synchronized æ˜¯ java ä¸­æä¾›ä¸€ä¸ªç”¨äºå®ç°çº¿ç¨‹åŒæ­¥çš„å…³é”®å­—ï¼Œé€šè¿‡ä½¿ç”¨è¯¥å…³é”®å­—ï¼Œå¯ä»¥æœ‰æ•ˆçš„è§£å†³çº¿ç¨‹å¹¶å‘æ—¶çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œè§£å†³çš„å¹¶å‘ç¼–ç¨‹ä¸­çš„åŸå­æ€§ã€‚synchronized æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>å¯¹è±¡é”ï¼ˆä½¿ç”¨ synchronized å…³é”®å¯¹å¯¹è±¡/å®ä¾‹é”å®šï¼‰</li>
<li>æ–¹æ³•é”ï¼ˆä½¿ç”¨ synchronized å¯¹æ–¹æ³•ä¿®é¥°é”å®šæ–¹æ³•ï¼‰</li>
<li>ç±»é”ï¼ˆä½¿ç”¨ synchronized ç›´æ¥é”å®šç±»ï¼‰</li>
</ul>
<h4 id="å¯¹è±¡é”" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡é”" aria-hidden="true">#</a> å¯¹è±¡é”</h4>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountOperation</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** è´¦æˆ·*/</span>
    <span class="token keyword">private</span> <span class="token class-name">Account</span> a<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** å¾…å–æ¬¾é‡‘é¢*/</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AccountOperation</span><span class="token punctuation">(</span><span class="token class-name">Account</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">.</span><span class="token function">giveMoney</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ–¹æ³•é”" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•é”" aria-hidden="true">#</a> æ–¹æ³•é”</h4>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token keyword">double</span> m<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">&lt;=</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
        money <span class="token operator">-=</span> m<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"å–æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š"</span> <span class="token operator">+</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä½™é¢ä¸è¶³ï¼Œ"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"å–æ¬¾å¤±è´¥!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç±»é”" tabindex="-1"><a class="header-anchor" href="#ç±»é”" aria-hidden="true">#</a> ç±»é”</h4>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token keyword">double</span> m<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">&lt;=</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
            money <span class="token operator">-=</span> m<span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"å–æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š"</span> <span class="token operator">+</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä½™é¢ä¸è¶³ï¼Œ"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"å–æ¬¾å¤±è´¥!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>ç±»é”çš„å¦ä¸€ç§å†™æ³•</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span>  <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token keyword">double</span> m<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">&lt;=</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
        money <span class="token operator">-=</span> m<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"å–æ¬¾æˆåŠŸï¼Œä½™é¢ï¼š"</span> <span class="token operator">+</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä½™é¢ä¸è¶³ï¼Œ"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"å–æ¬¾å¤±è´¥!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<h4 id="æ­»é”é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æ­»é”é—®é¢˜" aria-hidden="true">#</a> æ­»é”é—®é¢˜</h4>
<p>ä½¿ç”¨é”è™½ç„¶èƒ½å¤Ÿè§£å†³å¤šçº¿ç¨‹è®¿é—®å…±äº«å˜é‡é€ æˆçš„å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´æ­»é”ï¼›</p>
<p>æ­»é”å³å¤šä¸ªçº¿ç¨‹ç­‰å¾…è¢«å¯¹æ–¹çº¿ç¨‹å æœ‰çš„èµ„æºæ—¶é™·å…¥ä¸€ä¸ªåƒµå±€ã€‚</p>
<p><img src="@source/notes/java/05/04-çº¿ç¨‹ï¼ˆäºŒï¼‰/assets/1610614118889.png" alt="1610614118889"></p>
<p>å‚è€ƒä»£ç :</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–çº¿ç¨‹åç§°</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"å·²é”å®šo1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"æ‰§è¡Œå®Œæ¯•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"å·²é”å®šo2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"æ‰§è¡Œå®Œæ¯•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lock" tabindex="-1"><a class="header-anchor" href="#lock" aria-hidden="true">#</a> lock</h3>
<p>åœ¨ Java5 ä¸­æ–°å¢çš„å¹¶å‘ç¼–ç¨‹åŒ…ä¸­ï¼Œæä¾›ä¸€ç§æ–°å‹çš„é”æœºåˆ¶<code v-pre>Lock</code>,æä¾›äº†æ¯” synchronized åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„é”ï¼Œ<code v-pre>Lock</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦çš„å®ç°ç±»æ˜¯<code v-pre>ReentrantLock</code>ï¼ˆå¯é‡å…¥é”ï¼‰ï¼Œæä¾›äº†å…¬å¹³é”ä¸éå…¬å¹³é”æœºåˆ¶ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”çš„å®ç°ã€‚</p>
<p><strong>æ„é€ å™¨</strong></p>
<table>
<thead>
<tr>
<th><code v-pre>ReentrantLock()</code></th>
<th>åˆ›å»ºä¸€ä¸ª <code v-pre>ReentrantLock</code>çš„å®ä¾‹ã€‚</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>ReentrantLock(boolean fair)</code></td>
<td>æ ¹æ®ç»™å®šçš„å…¬å¹³æ”¿ç­–åˆ›å»ºä¸€ä¸ª <code v-pre>ReentrantLock</code>çš„å®ä¾‹ã€‚</td>
</tr>
</tbody>
</table>
<p>ç”¨æ³•å¦‚ä¸‹:</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaleTickets</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è·å–é”</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ä¹°åˆ°è½¦ç¥¨ï¼š"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">--</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>
                <span class="token comment">//è§£é”</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SaleTickets</span> st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaleTickets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span><span class="token string">"å°æ˜"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span><span class="token string">"å°çº¢"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span><span class="token string">"å°ç‹"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>æ³¨æ„äº‹é¡¹</p>
<p>ç”±äº Lock æ˜¯æ‰‹åŠ¨è·å–ä»¥åŠé‡Šæ”¾é”ï¼ˆåŒºåˆ« synchronized è‡ªåŠ¨é”æœºåˆ¶ï¼‰ï¼Œå› æ­¤ä¸€èˆ¬é”çš„è·å–ä¼šæ”¾åœ¨ try è¯­å¥å—ä¹‹å‰ï¼Œå¹¶ä¸”å¯¹äºé”çš„é‡Šæ”¾å¦‚æœä½¿ç”¨çš„ä½ç½®ä¸æ°å½“,å¾ˆæœ‰å¯èƒ½é€ æˆæ­»é”ï¼Œå› æ­¤å»ºè®®å°†é”çš„é‡Šæ”¾å®šä¹‰åœ¨ finally è¯­å¥å—ä¸­</p>
<p>synchornized å’Œ lock åŒºåˆ«ï¼Ÿ</p>
<p>synchronizedï¼š</p>
<ul>
<li>æ˜¯ java ä¸­æä¾›çš„ä¸€ä¸ªå…³é”®å­—</li>
<li>synchronized é”åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šè‡ªåŠ¨é‡Šæ”¾</li>
<li>synchronized æ˜¯ä¸€ç§éå…¬å¹³é”</li>
<li>synchronized é€‚ç”¨äºå°‘é‡çš„ä»£ç ç‰‡æ®µ</li>
</ul>
<p>lockï¼š</p>
<ul>
<li>æ˜¯ä¸€ä¸ª java ç±»ï¼Œæä¾›çš„åŠŸèƒ½è¦å¼ºå¤§äº synchronized</li>
<li>é”çš„é‡Šæ”¾éœ€è¦æ‰‹åŠ¨æ§åˆ¶ï¼Œå› æ­¤å¯ä»¥æ§åˆ¶ç²’åº¦æ›´ä¸ºç»†è…»çš„æ“ä½œ</li>
<li>lock æ—¢å¯ä»¥ä½¿ç”¨å…¬å¹³é”ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨éå…¬å¹³é”å®ç°</li>
<li>lock é€‚ç”¨äºå¤§é‡ä»£ç ç‰‡æ®µçš„é”æœºåˆ¶</li>
</ul>
</blockquote>
<h3 id="volatile" tabindex="-1"><a class="header-anchor" href="#volatile" aria-hidden="true">#</a> volatile</h3>
<p>åœ¨äº†è§£ volatile ä¹‹å‰ï¼Œå…ˆçœ‹ä»¥ä¸‹ä»£ç ï¼š</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isOver<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å­çº¿ç¨‹å¯åŠ¨"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>isOver<span class="token punctuation">)</span><span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹ç»ˆæ­¢ã€‚ã€‚ã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">VolatileDemo</span> vd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolatileDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>vd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vd<span class="token punctuation">.</span>isOver <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*

*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ åˆ†æä»¥ä¸Šç¨‹åºï¼Œå¯åŠ¨äº†ä¸¤æ¡çº¿ç¨‹ï¼Œå…¶ä¸­ä¸»çº¿ç¨‹ä¸­ç­‰å¾…ä¸‰ç§’ä¹‹åä¼šå°†ç»“æŸæ ‡è®°ä¿®æ”¹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè¢«ä¿®æ”¹çš„å˜é‡å€¼åº”è¯¥ç«‹å³è¢«å­çº¿ç¨‹è¯»å–ï¼Œä»è€Œç»“æŸå­çº¿ç¨‹ï¼›ä½†æ˜¯å®é™…æƒ…å†µæ˜¯ï¼Œå­çº¿ç¨‹å¹¶æœªç»“æŸï¼Œè€Œæ˜¯ä¸€ç›´å¾ªç¯æ‰§è¡Œã€‚</p>
<p>â€‹ äº§ç”ŸåŸå› å¦‚ä¸‹ï¼š</p>
<p><img src="@source/notes/java/05/04-çº¿ç¨‹ï¼ˆäºŒï¼‰/assets/1610613660958.png" alt="1610613660958"></p>
<p>å¦‚æœéœ€è¦å°†çº¿ç¨‹ä¸­å¯¹å˜é‡çš„ä¿®æ”¹ç«‹å³åŒæ­¥ç»™å…¶ä»–çº¿ç¨‹ï¼Œåªéœ€è¦å°†å˜é‡ä½¿ç”¨<code v-pre>volatile</code>å…³é”®å­—ä¿®é¥°å³å¯:</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isOver<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>volatile å¯ä»¥ä¿è¯æ•°æ®çš„<strong>å¯è§æ€§</strong>ä»¥åŠ<strong>æœ‰åºæ€§</strong>ï¼ˆä¸ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼‰ï¼Œä½†æ˜¯ä¸ä¿è¯åŸå­æ€§ã€‚</p>
<h2 id="ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#ä½œä¸š" aria-hidden="true">#</a> ä½œä¸š</h2>
<ul>
<li>
<p>æ€è€ƒï¼šè®¾è®¡ä¸€ä¸ªåŒ»é™¢çš„æŒ‚å·ç³»ç»Ÿï¼Œå­˜åœ¨å¤šå°æŒ‚å·æœºå™¨ï¼Œè¦æ±‚è¿™å¤šå°æŒ‚å·æœºå™¨èƒ½åŒæ—¶å·¥ä½œï¼ˆåŒæ—¶æ”¾å·ï¼‰ï¼Œå‘æ”¾çš„å·ç è¦æ±‚ä¸èƒ½å‡ºç°é‡å¤ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>çº¿ç¨‹A:1  5  8
çº¿ç¨‹B:2  4  9
çº¿ç¨‹C:3  6  7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¹¶ä¸”è¦æ±‚èƒ½å¤Ÿæ”¯æŒæ–­ç”µåå·ç ä¸è¿˜åŸï¼Œå³è‹¥å·ç å‘æ”¾åˆ° 9 å·ï¼Œæ­¤æ—¶æ–­ç”µäº†ï¼Œä¸‹ä¸€æ¬¡æ¢å¤ä¾›ç”µä¹‹åå·ç ä» 10 ç»§ç»­å¼€å§‹ã€‚</p>
</li>
</ul>
</div></template>


