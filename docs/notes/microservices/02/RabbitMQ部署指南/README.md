# RabbitMQ éƒ¨ç½²æŒ‡å— ğŸ§™

[[TOC]]

## 1.å•æœºéƒ¨ç½²

æˆ‘ä»¬åœ¨ Centos7 è™šæ‹Ÿæœºä¸­ä½¿ç”¨ Docker æ¥å®‰è£…ã€‚

# 1.1.ä¸‹è½½é•œåƒ

æ–¹å¼ä¸€ï¼šåœ¨çº¿æ‹‰å–

```sh
docker pull rabbitmq:3.8-management
```

æ–¹å¼äºŒï¼šä»æœ¬åœ°åŠ è½½

åœ¨è¯¾å‰èµ„æ–™å·²ç»æä¾›äº†é•œåƒåŒ…ï¼š

![image-20210423191210349](./assets/image-20210423191210349.png)

ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­åï¼Œä½¿ç”¨å‘½ä»¤åŠ è½½é•œåƒå³å¯ï¼š

```sh
docker load -i mq.tar
```

### 1.2.å®‰è£… MQ

æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡Œ MQ å®¹å™¨ï¼š

```sh
docker run \
 -e RABBITMQ_DEFAULT_USER=itcast \
 -e RABBITMQ_DEFAULT_PASS=123321 \
 -v mq-plugins:/plugins \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3.8-management
```

## 2.å®‰è£… DelayExchange æ’ä»¶

å®˜æ–¹çš„å®‰è£…æŒ‡å—åœ°å€ä¸ºï¼šhttps://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq

ä¸Šè¿°æ–‡æ¡£æ˜¯åŸºäº linux åŸç”Ÿå®‰è£… RabbitMQï¼Œç„¶åå®‰è£…æ’ä»¶ã€‚

å› ä¸ºæˆ‘ä»¬ä¹‹å‰æ˜¯åŸºäº Docker å®‰è£… RabbitMQï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä¼šè®²è§£åŸºäº Docker æ¥å®‰è£… RabbitMQ æ’ä»¶ã€‚

### 2.1.ä¸‹è½½æ’ä»¶

RabbitMQ æœ‰ä¸€ä¸ªå®˜æ–¹çš„æ’ä»¶ç¤¾åŒºï¼Œåœ°å€ä¸ºï¼šhttps://www.rabbitmq.com/community-plugins.html

å…¶ä¸­åŒ…å«å„ç§å„æ ·çš„æ’ä»¶ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è¦ä½¿ç”¨çš„ DelayExchange æ’ä»¶ï¼š

![image-20210713104511055](./assets/image-20210713104511055.png)

å¤§å®¶å¯ä»¥å»å¯¹åº”çš„ GitHub é¡µé¢ä¸‹è½½ 3.8.9 ç‰ˆæœ¬çš„æ’ä»¶ï¼Œåœ°å€ä¸ºhttps://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9è¿™ä¸ªå¯¹åº”RabbitMQçš„3.8.5ä»¥ä¸Šç‰ˆæœ¬ã€‚

è¯¾å‰èµ„æ–™ä¹Ÿæä¾›äº†ä¸‹è½½å¥½çš„æ’ä»¶ï¼š

![image-20210713104808909](./assets/image-20210713104808909.png)

### 2.2.ä¸Šä¼ æ’ä»¶

å› ä¸ºæˆ‘ä»¬æ˜¯åŸºäº Docker å®‰è£…ï¼Œæ‰€ä»¥éœ€è¦å…ˆæŸ¥çœ‹ RabbitMQ çš„æ’ä»¶ç›®å½•å¯¹åº”çš„æ•°æ®å·ã€‚å¦‚æœä¸æ˜¯åŸºäº Docker çš„åŒå­¦ï¼Œè¯·å‚è€ƒç¬¬ä¸€ç« éƒ¨åˆ†ï¼Œé‡æ–°åˆ›å»º Docker å®¹å™¨ã€‚

æˆ‘ä»¬ä¹‹å‰è®¾å®šçš„ RabbitMQ çš„æ•°æ®å·åç§°ä¸º`mq-plugins`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹æ•°æ®å·ï¼š

```sh
docker volume inspect mq-plugins
```

å¯ä»¥å¾—åˆ°ä¸‹é¢ç»“æœï¼š

![image-20210713105135701](./assets/image-20210713105135701.png)

æ¥ä¸‹æ¥ï¼Œå°†æ’ä»¶ä¸Šä¼ åˆ°è¿™ä¸ªç›®å½•å³å¯ï¼š

![image-20210713105339785](./assets/image-20210713105339785.png)

### 2.3.å®‰è£…æ’ä»¶

æœ€åå°±æ˜¯å®‰è£…äº†ï¼Œéœ€è¦è¿›å…¥ MQ å®¹å™¨å†…éƒ¨æ¥æ‰§è¡Œå®‰è£…ã€‚æˆ‘çš„å®¹å™¨åä¸º`mq`ï¼Œæ‰€ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
docker exec -it mq bash
```

æ‰§è¡Œæ—¶ï¼Œè¯·å°†å…¶ä¸­çš„ `-it` åé¢çš„`mq`æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å®¹å™¨å.

è¿›å…¥å®¹å™¨å†…éƒ¨åï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤å¼€å¯æ’ä»¶ï¼š

```sh
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

ç»“æœå¦‚ä¸‹ï¼š

![image-20210713105829435](./assets/image-20210713105829435.png)

## 3.é›†ç¾¤éƒ¨ç½²

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®‰è£… RabbitMQ çš„é›†ç¾¤ã€‚

### 2.1.é›†ç¾¤åˆ†ç±»

åœ¨ RabbitMQ çš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè®²è¿°äº†ä¸¤ç§é›†ç¾¤çš„é…ç½®æ–¹å¼ï¼š

- æ™®é€šæ¨¡å¼ï¼šæ™®é€šæ¨¡å¼é›†ç¾¤ä¸è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ¯ä¸ª MQ éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€æ•°æ®ä¿¡æ¯ï¼ˆå…¶å®ƒå…ƒæ•°æ®ä¿¡æ¯å¦‚äº¤æ¢æœºç­‰ä¼šåŒæ­¥ï¼‰ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰ 2 ä¸ª MQï¼šmq1ï¼Œå’Œ mq2ï¼Œå¦‚æœä½ çš„æ¶ˆæ¯åœ¨ mq1ï¼Œè€Œä½ è¿æ¥åˆ°äº† mq2ï¼Œé‚£ä¹ˆ mq2 ä¼šå» mq1 æ‹‰å–æ¶ˆæ¯ï¼Œç„¶åè¿”å›ç»™ä½ ã€‚å¦‚æœ mq1 å®•æœºï¼Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚
- é•œåƒæ¨¡å¼ï¼šä¸æ™®é€šæ¨¡å¼ä¸åŒï¼Œé˜Ÿåˆ—ä¼šåœ¨å„ä¸ª mq çš„é•œåƒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥ï¼Œå› æ­¤ä½ è¿æ¥åˆ°ä»»ä½•ä¸€ä¸ªé•œåƒèŠ‚ç‚¹ï¼Œå‡å¯è·å–åˆ°æ¶ˆæ¯ã€‚è€Œä¸”å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å¢åŠ äº†æ•°æ®åŒæ­¥çš„å¸¦å®½æ¶ˆè€—ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹æ™®é€šæ¨¡å¼é›†ç¾¤ï¼Œæˆ‘ä»¬çš„è®¡åˆ’éƒ¨ç½² 3 èŠ‚ç‚¹çš„ mq é›†ç¾¤ï¼š

| ä¸»æœºå | æ§åˆ¶å°ç«¯å£      | amqp é€šä¿¡ç«¯å£  |
| ------ | --------------- | -------------- |
| mq1    | 8081 ---> 15672 | 8071 ---> 5672 |
| mq2    | 8082 ---> 15672 | 8072 ---> 5672 |
| mq3    | 8083 ---> 15672 | 8073 ---> 5672 |

é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ ‡ç¤ºé»˜è®¤éƒ½æ˜¯ï¼š`rabbit@[hostname]`ï¼Œå› æ­¤ä»¥ä¸Šä¸‰ä¸ªèŠ‚ç‚¹çš„åç§°åˆ†åˆ«ä¸ºï¼š

- rabbit@mq1
- rabbit@mq2
- rabbit@mq3

### 2.2.è·å– cookie

RabbitMQ åº•å±‚ä¾èµ–äº Erlangï¼Œè€Œ Erlang è™šæ‹Ÿæœºå°±æ˜¯ä¸€ä¸ªé¢å‘åˆ†å¸ƒå¼çš„è¯­è¨€ï¼Œé»˜è®¤å°±æ”¯æŒé›†ç¾¤æ¨¡å¼ã€‚é›†ç¾¤æ¨¡å¼ä¸­çš„æ¯ä¸ª RabbitMQ èŠ‚ç‚¹ä½¿ç”¨ cookie æ¥ç¡®å®šå®ƒä»¬æ˜¯å¦è¢«å…è®¸ç›¸äº’é€šä¿¡ã€‚

è¦ä½¿ä¸¤ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿé€šä¿¡ï¼Œå®ƒä»¬å¿…é¡»å…·æœ‰ç›¸åŒçš„å…±äº«ç§˜å¯†ï¼Œç§°ä¸º**Erlang cookie**ã€‚cookie åªæ˜¯ä¸€ä¸²æœ€å¤š 255 ä¸ªå­—ç¬¦çš„å­—æ¯æ•°å­—å­—ç¬¦ã€‚

æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹å¿…é¡»å…·æœ‰**ç›¸åŒçš„ cookie**ã€‚å®ä¾‹ä¹‹é—´ä¹Ÿéœ€è¦å®ƒæ¥ç›¸äº’é€šä¿¡ã€‚

æˆ‘ä»¬å…ˆåœ¨ä¹‹å‰å¯åŠ¨çš„ mq å®¹å™¨ä¸­è·å–ä¸€ä¸ª cookie å€¼ï¼Œä½œä¸ºé›†ç¾¤çš„ cookieã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```sh
docker exec -it mq cat /var/lib/rabbitmq/.erlang.cookie
```

å¯ä»¥çœ‹åˆ° cookie å€¼å¦‚ä¸‹ï¼š

```sh
FXZMCVGLBIXZCDEMMVZQ
```

æ¥ä¸‹æ¥ï¼Œåœæ­¢å¹¶åˆ é™¤å½“å‰çš„ mq å®¹å™¨ï¼Œæˆ‘ä»¬é‡æ–°æ­å»ºé›†ç¾¤ã€‚

```sh
docker rm -f mq
```

![image-20210717212345165](./assets/image-20210717212345165.png)

### 2.3.å‡†å¤‡é›†ç¾¤é…ç½®

åœ¨/tmp ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ rabbitmq.confï¼š

```sh
cd /tmp
# åˆ›å»ºæ–‡ä»¶
touch rabbitmq.conf
```

æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```nginx
loopback_users.guest = false
listeners.tcp.default = 5672
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@mq1
cluster_formation.classic_config.nodes.2 = rabbit@mq2
cluster_formation.classic_config.nodes.3 = rabbit@mq3
```

å†åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè®°å½• cookie

```sh
cd /tmp
# åˆ›å»ºcookieæ–‡ä»¶
touch .erlang.cookie
# å†™å…¥cookie
echo "FXZMCVGLBIXZCDEMMVZQ" > .erlang.cookie
# ä¿®æ”¹cookieæ–‡ä»¶çš„æƒé™
chmod 600 .erlang.cookie
```

å‡†å¤‡ä¸‰ä¸ªç›®å½•,mq1ã€mq2ã€mq3ï¼š

```sh
cd /tmp
# åˆ›å»ºç›®å½•
mkdir mq1 mq2 mq3
```

ç„¶åæ‹·è´ rabbitmq.confã€cookie æ–‡ä»¶åˆ° mq1ã€mq2ã€mq3ï¼š

```sh
# è¿›å…¥/tmp
cd /tmp
# æ‹·è´
cp rabbitmq.conf mq1
cp rabbitmq.conf mq2
cp rabbitmq.conf mq3
cp .erlang.cookie mq1
cp .erlang.cookie mq2
cp .erlang.cookie mq3
```

### 2.4.å¯åŠ¨é›†ç¾¤

åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š

```sh
docker network create mq-net
```

docker volume create

è¿è¡Œå‘½ä»¤

```sh
docker run -d --net mq-net \
-v ${PWD}/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq1 \
--hostname mq1 \
-p 8071:5672 \
-p 8081:15672 \
rabbitmq:3.8-management
```

```sh
docker run -d --net mq-net \
-v ${PWD}/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq2 \
--hostname mq2 \
-p 8072:5672 \
-p 8082:15672 \
rabbitmq:3.8-management
```

```sh
docker run -d --net mq-net \
-v ${PWD}/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq3 \
--hostname mq3 \
-p 8073:5672 \
-p 8083:15672 \
rabbitmq:3.8-management
```

### 2.5.æµ‹è¯•

åœ¨ mq1 è¿™ä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼š

![image-20210717222833196](./assets/image-20210717222833196.png)

å¦‚å›¾ï¼Œåœ¨ mq2 å’Œ mq3 ä¸¤ä¸ªæ§åˆ¶å°ä¹Ÿéƒ½èƒ½çœ‹åˆ°ï¼š

![image-20210717223057902](./assets/image-20210717223057902.png)

#### 2.5.1.æ•°æ®å…±äº«æµ‹è¯•

ç‚¹å‡»è¿™ä¸ªé˜Ÿåˆ—ï¼Œè¿›å…¥ç®¡ç†é¡µé¢ï¼š

![image-20210717223421750](./assets/image-20210717223421750.png)

ç„¶ååˆ©ç”¨æ§åˆ¶å°å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼š

![image-20210717223320238](./assets/image-20210717223320238.png)

ç»“æœåœ¨ mq2ã€mq3 ä¸Šéƒ½èƒ½çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼š

![image-20210717223603628](./assets/image-20210717223603628.png)

#### 2.5.2.å¯ç”¨æ€§æµ‹è¯•

æˆ‘ä»¬è®©å…¶ä¸­ä¸€å°èŠ‚ç‚¹ mq1 å®•æœºï¼š

```sh
docker stop mq1
```

ç„¶åç™»å½• mq2 æˆ– mq3 çš„æ§åˆ¶å°ï¼Œå‘ç° simple.queue ä¹Ÿä¸å¯ç”¨äº†ï¼š

![image-20210717223800203](./assets/image-20210717223800203.png)

è¯´æ˜æ•°æ®å¹¶æ²¡æœ‰æ‹·è´åˆ° mq2 å’Œ mq3ã€‚

## 4.é•œåƒæ¨¡å¼

åœ¨åˆšåˆšçš„æ¡ˆä¾‹ä¸­ï¼Œä¸€æ—¦åˆ›å»ºé˜Ÿåˆ—çš„ä¸»æœºå®•æœºï¼Œé˜Ÿåˆ—å°±ä¼šä¸å¯ç”¨ã€‚ä¸å…·å¤‡é«˜å¯ç”¨èƒ½åŠ›ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨å®˜æ–¹æä¾›çš„é•œåƒé›†ç¾¤æ–¹æ¡ˆã€‚

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://www.rabbitmq.com/ha.html

### 4.1.é•œåƒæ¨¡å¼çš„ç‰¹å¾

é»˜è®¤æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—åªä¿å­˜åœ¨åˆ›å»ºè¯¥é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¸Šã€‚è€Œé•œåƒæ¨¡å¼ä¸‹ï¼Œåˆ›å»ºé˜Ÿåˆ—çš„èŠ‚ç‚¹è¢«ç§°ä¸ºè¯¥é˜Ÿåˆ—çš„**ä¸»èŠ‚ç‚¹**ï¼Œé˜Ÿåˆ—è¿˜ä¼šæ‹·è´åˆ°é›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ï¼Œä¹Ÿå«åšè¯¥é˜Ÿåˆ—çš„**é•œåƒ**èŠ‚ç‚¹ã€‚

ä½†æ˜¯ï¼Œä¸åŒé˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä»»æ„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œå› æ­¤ä¸åŒé˜Ÿåˆ—çš„ä¸»èŠ‚ç‚¹å¯ä»¥ä¸åŒã€‚ç”šè‡³ï¼Œ**ä¸€ä¸ªé˜Ÿåˆ—çš„ä¸»èŠ‚ç‚¹å¯èƒ½æ˜¯å¦ä¸€ä¸ªé˜Ÿåˆ—çš„é•œåƒèŠ‚ç‚¹**ã€‚

ç”¨æˆ·å‘é€ç»™é˜Ÿåˆ—çš„ä¸€åˆ‡è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€æ¶ˆæ¯ã€æ¶ˆæ¯å›æ‰§é»˜è®¤éƒ½ä¼šåœ¨ä¸»èŠ‚ç‚¹å®Œæˆï¼Œå¦‚æœæ˜¯ä»èŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚ï¼Œä¹Ÿä¼šè·¯ç”±åˆ°ä¸»èŠ‚ç‚¹å»å®Œæˆã€‚**é•œåƒèŠ‚ç‚¹ä»…ä»…èµ·åˆ°å¤‡ä»½æ•°æ®ä½œç”¨**ã€‚

å½“ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°æ¶ˆè´¹è€…çš„ ACK æ—¶ï¼Œæ‰€æœ‰é•œåƒéƒ½ä¼šåˆ é™¤èŠ‚ç‚¹ä¸­çš„æ•°æ®ã€‚

æ€»ç»“å¦‚ä¸‹ï¼š

- é•œåƒé˜Ÿåˆ—ç»“æ„æ˜¯ä¸€ä¸»å¤šä»ï¼ˆä»å°±æ˜¯é•œåƒï¼‰
- æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸»èŠ‚ç‚¹å®Œæˆï¼Œç„¶ååŒæ­¥ç»™é•œåƒèŠ‚ç‚¹
- ä¸»å®•æœºåï¼Œé•œåƒèŠ‚ç‚¹ä¼šæ›¿ä»£æˆæ–°çš„ä¸»ï¼ˆå¦‚æœåœ¨ä¸»ä»åŒæ­¥å®Œæˆå‰ï¼Œä¸»å°±å·²ç»å®•æœºï¼Œå¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±ï¼‰
- ä¸å…·å¤‡è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå› ä¸ºæ‰€æœ‰æ“ä½œéƒ½ä¼šæœ‰ä¸»èŠ‚ç‚¹å®Œæˆï¼ˆä½†æ˜¯ä¸åŒé˜Ÿåˆ—ï¼Œå…¶ä¸»èŠ‚ç‚¹å¯ä»¥ä¸åŒï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæé«˜ååé‡ï¼‰

### 4.2.é•œåƒæ¨¡å¼çš„é…ç½®

é•œåƒæ¨¡å¼çš„é…ç½®æœ‰ 3 ç§æ¨¡å¼ï¼š

| ha-mode          | ha-params          | æ•ˆæœ                                                                                                                                                                                                                                                                                                                                       |
| :--------------- | :----------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å‡†ç¡®æ¨¡å¼ exactly | é˜Ÿåˆ—çš„å‰¯æœ¬é‡ count | é›†ç¾¤ä¸­é˜Ÿåˆ—å‰¯æœ¬ï¼ˆä¸»æœåŠ¡å™¨å’Œé•œåƒæœåŠ¡å™¨ä¹‹å’Œï¼‰çš„æ•°é‡ã€‚count å¦‚æœä¸º 1 æ„å‘³ç€å•ä¸ªå‰¯æœ¬ï¼šå³é˜Ÿåˆ—ä¸»èŠ‚ç‚¹ã€‚count å€¼ä¸º 2 è¡¨ç¤º 2 ä¸ªå‰¯æœ¬ï¼š1 ä¸ªé˜Ÿåˆ—ä¸»å’Œ 1 ä¸ªé˜Ÿåˆ—é•œåƒã€‚æ¢å¥è¯è¯´ï¼šcount = é•œåƒæ•°é‡ + 1ã€‚å¦‚æœç¾¤é›†ä¸­çš„èŠ‚ç‚¹æ•°å°‘äº countï¼Œåˆ™è¯¥é˜Ÿåˆ—å°†é•œåƒåˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦‚æœæœ‰é›†ç¾¤æ€»æ•°å¤§äº count+1ï¼Œå¹¶ä¸”åŒ…å«é•œåƒçš„èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œåˆ™å°†åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚ |
| all              | (none)             | é˜Ÿåˆ—åœ¨ç¾¤é›†ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé•œåƒã€‚é˜Ÿåˆ—å°†é•œåƒåˆ°ä»»ä½•æ–°åŠ å…¥çš„èŠ‚ç‚¹ã€‚é•œåƒåˆ°æ‰€æœ‰èŠ‚ç‚¹å°†å¯¹æ‰€æœ‰ç¾¤é›†èŠ‚ç‚¹æ–½åŠ é¢å¤–çš„å‹åŠ›ï¼ŒåŒ…æ‹¬ç½‘ç»œ I / Oï¼Œç£ç›˜ I / O å’Œç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µã€‚æ¨èä½¿ç”¨ exactlyï¼Œè®¾ç½®å‰¯æœ¬æ•°ä¸ºï¼ˆN / 2 +1ï¼‰ã€‚                                                                                                                                |
| nodes            | _node names_       | æŒ‡å®šé˜Ÿåˆ—åˆ›å»ºåˆ°å“ªäº›èŠ‚ç‚¹ï¼Œå¦‚æœæŒ‡å®šçš„èŠ‚ç‚¹å…¨éƒ¨ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚å¦‚æœæŒ‡å®šçš„èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­å­˜åœ¨ï¼Œä½†æ˜¯æš‚æ—¶ä¸å¯ç”¨ï¼Œä¼šåˆ›å»ºèŠ‚ç‚¹åˆ°å½“å‰å®¢æˆ·ç«¯è¿æ¥åˆ°çš„èŠ‚ç‚¹ã€‚                                                                                                                                                                                           |

è¿™é‡Œæˆ‘ä»¬ä»¥ rabbitmqctl å‘½ä»¤ä½œä¸ºæ¡ˆä¾‹æ¥è®²è§£é…ç½®è¯­æ³•ã€‚

è¯­æ³•ç¤ºä¾‹ï¼š

#### 4.2.1.exactly æ¨¡å¼

```
rabbitmqctl set_policy ha-two "^two\." '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'
```

- `rabbitmqctl set_policy`ï¼šå›ºå®šå†™æ³•
- `ha-two`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^two\."`ï¼šåŒ¹é…é˜Ÿåˆ—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç¬¦åˆå‘½åè§„åˆ™çš„é˜Ÿåˆ—æ‰ç”Ÿæ•ˆï¼Œè¿™é‡Œæ˜¯ä»»ä½•ä»¥`two.`å¼€å¤´çš„é˜Ÿåˆ—åç§°
- `'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'`: ç­–ç•¥å†…å®¹
  - `"ha-mode":"exactly"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯ exactly æ¨¡å¼ï¼ŒæŒ‡å®šå‰¯æœ¬æ•°é‡
  - `"ha-params":2`ï¼šç­–ç•¥å‚æ•°ï¼Œè¿™é‡Œæ˜¯ 2ï¼Œå°±æ˜¯å‰¯æœ¬æ•°é‡ä¸º 2ï¼Œ1 ä¸» 1 é•œåƒ
  - `"ha-sync-mode":"automatic"`ï¼šåŒæ­¥ç­–ç•¥ï¼Œé»˜è®¤æ˜¯ manualï¼Œå³æ–°åŠ å…¥çš„é•œåƒèŠ‚ç‚¹ä¸ä¼šåŒæ­¥æ—§çš„æ¶ˆæ¯ã€‚å¦‚æœè®¾ç½®ä¸º automaticï¼Œåˆ™æ–°åŠ å…¥çš„é•œåƒèŠ‚ç‚¹ä¼šæŠŠä¸»èŠ‚ç‚¹ä¸­æ‰€æœ‰æ¶ˆæ¯éƒ½åŒæ­¥ï¼Œä¼šå¸¦æ¥é¢å¤–çš„ç½‘ç»œå¼€é”€

#### 4.2.2.all æ¨¡å¼

```
rabbitmqctl set_policy ha-all "^all\." '{"ha-mode":"all"}'
```

- `ha-all`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^all\."`ï¼šåŒ¹é…æ‰€æœ‰ä»¥`all.`å¼€å¤´çš„é˜Ÿåˆ—å
- `'{"ha-mode":"all"}'`ï¼šç­–ç•¥å†…å®¹
  - `"ha-mode":"all"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯ all æ¨¡å¼ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šç§°ä¸ºé•œåƒèŠ‚ç‚¹

#### 4.2.3.nodes æ¨¡å¼

```
rabbitmqctl set_policy ha-nodes "^nodes\." '{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'
```

- `rabbitmqctl set_policy`ï¼šå›ºå®šå†™æ³•
- `ha-nodes`ï¼šç­–ç•¥åç§°ï¼Œè‡ªå®šä¹‰
- `"^nodes\."`ï¼šåŒ¹é…é˜Ÿåˆ—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç¬¦åˆå‘½åè§„åˆ™çš„é˜Ÿåˆ—æ‰ç”Ÿæ•ˆï¼Œè¿™é‡Œæ˜¯ä»»ä½•ä»¥`nodes.`å¼€å¤´çš„é˜Ÿåˆ—åç§°
- `'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'`: ç­–ç•¥å†…å®¹
  - `"ha-mode":"nodes"`ï¼šç­–ç•¥æ¨¡å¼ï¼Œæ­¤å¤„æ˜¯ nodes æ¨¡å¼
  - `"ha-params":["rabbit@mq1", "rabbit@mq2"]`ï¼šç­–ç•¥å‚æ•°ï¼Œè¿™é‡ŒæŒ‡å®šå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹åç§°

### 4.3.æµ‹è¯•

æˆ‘ä»¬ä½¿ç”¨ exactly æ¨¡å¼çš„é•œåƒï¼Œå› ä¸ºé›†ç¾¤èŠ‚ç‚¹æ•°é‡ä¸º 3ï¼Œå› æ­¤é•œåƒæ•°é‡å°±è®¾ç½®ä¸º 2.

è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```sh
docker exec -it mq1 rabbitmqctl set_policy ha-two "^two\." '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'
```

ä¸‹é¢ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é˜Ÿåˆ—ï¼š

![image-20210717231751411](./assets/image-20210717231751411.png)

åœ¨ä»»æ„ä¸€ä¸ª mq æ§åˆ¶å°æŸ¥çœ‹é˜Ÿåˆ—ï¼š

![image-20210717231829505](./assets/image-20210717231829505.png)

#### 4.3.1.æµ‹è¯•æ•°æ®å…±äº«

ç»™ two.queue å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š

![image-20210717231958996](./assets/image-20210717231958996.png)

ç„¶ååœ¨ mq1ã€mq2ã€mq3 çš„ä»»æ„æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯ï¼š

![image-20210717232108584](./assets/image-20210717232108584.png)

#### 4.3.2.æµ‹è¯•é«˜å¯ç”¨

ç°åœ¨ï¼Œæˆ‘ä»¬è®© two.queue çš„ä¸»èŠ‚ç‚¹ mq1 å®•æœºï¼š

```sh
docker stop mq1
```

æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

![image-20210717232257420](./assets/image-20210717232257420.png)

æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€ï¼š

![image-20210717232322646](./assets/image-20210717232322646.png)

å‘ç°ä¾ç„¶æ˜¯å¥åº·çš„ï¼å¹¶ä¸”å…¶ä¸»èŠ‚ç‚¹åˆ‡æ¢åˆ°äº† rabbit@mq2 ä¸Š

## 5.ä»²è£é˜Ÿåˆ—

ä» RabbitMQ 3.8 ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†æ–°çš„ä»²è£é˜Ÿåˆ—ï¼Œä»–å…·å¤‡ä¸é•œåƒé˜Ÿé‡Œç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä½¿ç”¨æ›´åŠ æ–¹ä¾¿ã€‚

### 5.1.æ·»åŠ ä»²è£é˜Ÿåˆ—

åœ¨ä»»æ„æ§åˆ¶å°æ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€å®šè¦é€‰æ‹©é˜Ÿåˆ—ç±»å‹ä¸º Quorum ç±»å‹ã€‚

![image-20210717234329640](./assets/image-20210717234329640.png)

åœ¨ä»»æ„æ§åˆ¶å°æŸ¥çœ‹é˜Ÿåˆ—ï¼š

![image-20210717234426209](./assets/image-20210717234426209.png)

å¯ä»¥çœ‹åˆ°ï¼Œä»²è£é˜Ÿåˆ—çš„ + 2 å­—æ ·ã€‚ä»£è¡¨è¿™ä¸ªé˜Ÿåˆ—æœ‰ 2 ä¸ªé•œåƒèŠ‚ç‚¹ã€‚

å› ä¸ºä»²è£é˜Ÿåˆ—é»˜è®¤çš„é•œåƒæ•°ä¸º 5ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰ 7 ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆé•œåƒæ•°è‚¯å®šæ˜¯ 5ï¼›è€Œæˆ‘ä»¬é›†ç¾¤åªæœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œå› æ­¤é•œåƒæ•°é‡å°±æ˜¯ 3.

### 5.2.æµ‹è¯•

å¯ä»¥å‚è€ƒå¯¹é•œåƒé›†ç¾¤çš„æµ‹è¯•ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

### 5.3.é›†ç¾¤æ‰©å®¹

#### 5.3.1.åŠ å…¥é›†ç¾¤

1ï¼‰å¯åŠ¨ä¸€ä¸ªæ–°çš„ MQ å®¹å™¨ï¼š

```sh
docker run -d --net mq-net \
-v ${PWD}/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \
-e RABBITMQ_DEFAULT_USER=itcast \
-e RABBITMQ_DEFAULT_PASS=123321 \
--name mq4 \
--hostname mq5 \
-p 8074:15672 \
-p 8084:15672 \
rabbitmq:3.8-management
```

2ï¼‰è¿›å…¥å®¹å™¨æ§åˆ¶å°ï¼š

```sh
docker exec -it mq4 bash
```

3ï¼‰åœæ­¢ mq è¿›ç¨‹

```sh
rabbitmqctl stop_app
```

4ï¼‰é‡ç½® RabbitMQ ä¸­çš„æ•°æ®ï¼š

```sh
rabbitmqctl reset
```

5ï¼‰åŠ å…¥ mq1ï¼š

```sh
rabbitmqctl join_cluster rabbit@mq1
```

6ï¼‰å†æ¬¡å¯åŠ¨ mq è¿›ç¨‹

```sh
rabbitmqctl start_app
```

![image-20210718001909492](./assets/image-20210718001909492.png)

#### 5.3.2.å¢åŠ ä»²è£é˜Ÿåˆ—å‰¯æœ¬

æˆ‘ä»¬å…ˆæŸ¥çœ‹ä¸‹ quorum.queue è¿™ä¸ªé˜Ÿåˆ—ç›®å‰çš„å‰¯æœ¬æƒ…å†µï¼Œè¿›å…¥ mq1 å®¹å™¨ï¼š

```sh
docker exec -it mq1 bash
```

æ‰§è¡Œå‘½ä»¤ï¼š

```sh
rabbitmq-queues quorum_status "quorum.queue"
```

ç»“æœï¼š

![image-20210718002118357](./assets/image-20210718002118357.png)

ç°åœ¨ï¼Œæˆ‘ä»¬è®© mq4 ä¹ŸåŠ å…¥è¿›æ¥ï¼š

```sh
rabbitmq-queues add_member "quorum.queue" "rabbit@mq4"
```

ç»“æœï¼š

![image-20210718002253226](./assets/image-20210718002253226.png)

å†æ¬¡æŸ¥çœ‹ï¼š

```sh
rabbitmq-queues quorum_status "quorum.queue"
```

![image-20210718002342603](./assets/image-20210718002342603.png)

æŸ¥çœ‹æ§åˆ¶å°ï¼Œå‘ç° quorum.queue çš„é•œåƒæ•°é‡ä¹Ÿä»åŸæ¥çš„ +2 å˜æˆäº† +3ï¼š

![image-20210718002422365](./assets/image-20210718002422365.png)
