# Redis é›†ç¾¤ ğŸ§™

[[TOC]]

æœ¬ç« æ˜¯åŸºäº CentOS7 ä¸‹çš„ Redis é›†ç¾¤æ•™ç¨‹ï¼ŒåŒ…æ‹¬ï¼š

- å•æœºå®‰è£… Redis
- Redis ä¸»ä»
- Redis åˆ†ç‰‡é›†ç¾¤

# 1.å•æœºå®‰è£… Redis

é¦–å…ˆéœ€è¦å®‰è£… Redis æ‰€éœ€è¦çš„ä¾èµ–ï¼š

```sh
yum install -y gcc tcl
```

ç„¶åå°†è¯¾å‰èµ„æ–™æä¾›çš„ Redis å®‰è£…åŒ…ä¸Šä¼ åˆ°è™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ï¼š

![image-20210629114325516](./assets/image-20210629114325516.png)

ä¾‹å¦‚ï¼Œæˆ‘æ”¾åˆ°äº†/tmp ç›®å½•ï¼š

![image-20210629114830642](./assets/image-20210629114830642.png)

è§£å‹ç¼©ï¼š

```sh
tar -xvf redis-6.2.4.tar.gz
```

è§£å‹åï¼š

![image-20210629114941810](./assets/image-20210629114941810.png)

è¿›å…¥ redis ç›®å½•ï¼š

```sh
cd redis-6.2.4
```

è¿è¡Œç¼–è¯‘å‘½ä»¤ï¼š

```sh
make && make install
```

å¦‚æœæ²¡æœ‰å‡ºé”™ï¼Œåº”è¯¥å°±å®‰è£…æˆåŠŸäº†ã€‚

ç„¶åä¿®æ”¹ redis.conf æ–‡ä»¶ä¸­çš„ä¸€äº›é…ç½®ï¼š

```properties
# ç»‘å®šåœ°å€ï¼Œé»˜è®¤æ˜¯127.0.0.1ï¼Œä¼šå¯¼è‡´åªèƒ½åœ¨æœ¬åœ°è®¿é—®ã€‚ä¿®æ”¹ä¸º0.0.0.0åˆ™å¯ä»¥åœ¨ä»»æ„IPè®¿é—®
bind 0.0.0.0
# æ•°æ®åº“æ•°é‡ï¼Œè®¾ç½®ä¸º1
databases 1
```

å¯åŠ¨ Redisï¼š

```sh
redis-server redis.conf
```

åœæ­¢ redis æœåŠ¡ï¼š

```sh
redis-cli shutdown
```

# 2.Redis ä¸»ä»é›†ç¾¤

## 2.1.é›†ç¾¤ç»“æ„

æˆ‘ä»¬æ­å»ºçš„ä¸»ä»é›†ç¾¤ç»“æ„å¦‚å›¾ï¼š

![image-20210630111505799](./assets/image-20210630111505799.png)

å…±åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªä»èŠ‚ç‚¹ã€‚

è¿™é‡Œæˆ‘ä»¬ä¼šåœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸­å¼€å¯ 3 ä¸ª redis å®ä¾‹ï¼Œæ¨¡æ‹Ÿä¸»ä»é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š

|       IP        | PORT |  è§’è‰²  |
| :-------------: | :--: | :----: |
| 192.168.150.101 | 7001 | master |
| 192.168.150.101 | 7002 | slave  |
| 192.168.150.101 | 7003 | slave  |

## 2.2.å‡†å¤‡å®ä¾‹å’Œé…ç½®

è¦åœ¨åŒä¸€å°è™šæ‹Ÿæœºå¼€å¯ 3 ä¸ªå®ä¾‹ï¼Œå¿…é¡»å‡†å¤‡ä¸‰ä»½ä¸åŒçš„é…ç½®æ–‡ä»¶å’Œç›®å½•ï¼Œé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¹Ÿå°±æ˜¯å·¥ä½œç›®å½•ã€‚

1ï¼‰åˆ›å»ºç›®å½•

æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—åˆ†åˆ«å« 7001ã€7002ã€7003ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# åˆ›å»ºç›®å½•
mkdir 7001 7002 7003
```

å¦‚å›¾ï¼š

![image-20210630113929868](./assets/image-20210630113929868.png)

2ï¼‰æ¢å¤åŸå§‹é…ç½®

ä¿®æ”¹ redis-6.2.4/redis.conf æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„æŒä¹…åŒ–æ¨¡å¼æ”¹ä¸ºé»˜è®¤çš„ RDB æ¨¡å¼ï¼ŒAOF ä¿æŒå…³é—­çŠ¶æ€ã€‚

```properties
# å¼€å¯RDB
# save ""
save 3600 1
save 300 100
save 60 10000

# å…³é—­AOF
appendonly no
```

3ï¼‰æ‹·è´é…ç½®æ–‡ä»¶åˆ°æ¯ä¸ªå®ä¾‹ç›®å½•

ç„¶åå°† redis-6.2.4/redis.conf æ–‡ä»¶æ‹·è´åˆ°ä¸‰ä¸ªç›®å½•ä¸­ï¼ˆåœ¨/tmp ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼‰ï¼š

```sh
# æ–¹å¼ä¸€ï¼šé€ä¸ªæ‹·è´
cp redis-6.2.4/redis.conf 7001
cp redis-6.2.4/redis.conf 7002
cp redis-6.2.4/redis.conf 7003
# æ–¹å¼äºŒï¼šç®¡é“ç»„åˆå‘½ä»¤ï¼Œä¸€é”®æ‹·è´
echo 7001 7002 7003 | xargs -t -n 1 cp redis-6.2.4/redis.conf
```

4ï¼‰ä¿®æ”¹æ¯ä¸ªå®ä¾‹çš„ç«¯å£ã€å·¥ä½œç›®å½•

ä¿®æ”¹æ¯ä¸ªæ–‡ä»¶å¤¹å†…çš„é…ç½®æ–‡ä»¶ï¼Œå°†ç«¯å£åˆ†åˆ«ä¿®æ”¹ä¸º 7001ã€7002ã€7003ï¼Œå°† rdb æ–‡ä»¶ä¿å­˜ä½ç½®éƒ½ä¿®æ”¹ä¸ºè‡ªå·±æ‰€åœ¨ç›®å½•ï¼ˆåœ¨/tmp ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼‰ï¼š

```sh
sed -i -e 's/6379/7001/g' -e 's/dir .\//dir \/tmp\/7001\//g' 7001/redis.conf
sed -i -e 's/6379/7002/g' -e 's/dir .\//dir \/tmp\/7002\//g' 7002/redis.conf
sed -i -e 's/6379/7003/g' -e 's/dir .\//dir \/tmp\/7003\//g' 7003/redis.conf
```

5ï¼‰ä¿®æ”¹æ¯ä¸ªå®ä¾‹çš„å£°æ˜ IP

è™šæ‹Ÿæœºæœ¬èº«æœ‰å¤šä¸ª IPï¼Œä¸ºäº†é¿å…å°†æ¥æ··ä¹±ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ redis.conf æ–‡ä»¶ä¸­æŒ‡å®šæ¯ä¸€ä¸ªå®ä¾‹çš„ç»‘å®š ip ä¿¡æ¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```properties
# rediså®ä¾‹çš„å£°æ˜ IP
replica-announce-ip 192.168.150.101
```

æ¯ä¸ªç›®å½•éƒ½è¦æ”¹ï¼Œæˆ‘ä»¬ä¸€é”®å®Œæˆä¿®æ”¹ï¼ˆåœ¨/tmp ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼‰ï¼š

```sh
# é€ä¸€æ‰§è¡Œ
sed -i '1a replica-announce-ip 192.168.150.101' 7001/redis.conf
sed -i '1a replica-announce-ip 192.168.150.101' 7002/redis.conf
sed -i '1a replica-announce-ip 192.168.150.101' 7003/redis.conf

# æˆ–è€…ä¸€é”®ä¿®æ”¹
printf '%s\n' 7001 7002 7003 | xargs -I{} -t sed -i '1a replica-announce-ip 192.168.126.129' {}/redis.conf
```

## 2.3.å¯åŠ¨

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬æ‰“å¼€ 3 ä¸ª ssh çª—å£ï¼Œåˆ†åˆ«å¯åŠ¨ 3 ä¸ª redis å®ä¾‹ï¼Œå¯åŠ¨å‘½ä»¤ï¼š

```sh
# ç¬¬1ä¸ª
redis-server 7001/redis.conf
# ç¬¬2ä¸ª
redis-server 7002/redis.conf
# ç¬¬3ä¸ª
redis-server 7003/redis.conf
```

å¯åŠ¨åï¼š

![image-20210630183914491](./assets/image-20210630183914491.png)

å¦‚æœè¦ä¸€é”®åœæ­¢ï¼Œå¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
printf '%s\n' 7001 7002 7003 | xargs -I{} -t redis-cli -p {} shutdown
```

## 2.4.å¼€å¯ä¸»ä»å…³ç³»

ç°åœ¨ä¸‰ä¸ªå®ä¾‹è¿˜æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¦é…ç½®ä¸»ä»å¯ä»¥ä½¿ç”¨ replicaof æˆ–è€… slaveofï¼ˆ5.0 ä»¥å‰ï¼‰å‘½ä»¤ã€‚

æœ‰ä¸´æ—¶å’Œæ°¸ä¹…ä¸¤ç§æ¨¡å¼ï¼š

- ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰

  - åœ¨ redis.conf ä¸­æ·»åŠ ä¸€è¡Œé…ç½®ï¼š`slaveof <masterip> <masterport>`

- ä½¿ç”¨ redis-cli å®¢æˆ·ç«¯è¿æ¥åˆ° redis æœåŠ¡ï¼Œæ‰§è¡Œ slaveof å‘½ä»¤ï¼ˆé‡å¯åå¤±æ•ˆï¼‰ï¼š

  ```sh
  slaveof <masterip> <masterport>
  ```

<strong><font color='red'>æ³¨æ„</font></strong>ï¼šåœ¨ 5.0 ä»¥åæ–°å¢å‘½ä»¤ replicaofï¼Œä¸ salveof æ•ˆæœä¸€è‡´ã€‚

è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä½¿ç”¨æ–¹å¼äºŒã€‚

é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7002ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
# è¿æ¥ 7002
redis-cli -p 7002
# æ‰§è¡Œslaveof
slaveof 192.168.126.129 7001
```

é€šè¿‡ redis-cli å‘½ä»¤è¿æ¥ 7003ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š

```sh
# è¿æ¥ 7003
redis-cli -p 7003
# æ‰§è¡Œslaveof
slaveof 192.168.126.129 7001
```

ç„¶åè¿æ¥ 7001 èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

```sh
# è¿æ¥ 7001
redis-cli -p 7001
# æŸ¥çœ‹çŠ¶æ€
info replication
```

ç»“æœï¼š

![image-20210630201258802](./assets/image-20210630201258802.png)

## 2.5.æµ‹è¯•

æ‰§è¡Œä¸‹åˆ—æ“ä½œä»¥æµ‹è¯•ï¼š

- åˆ©ç”¨ redis-cli è¿æ¥ 7001ï¼Œæ‰§è¡Œ`set num 123`

- åˆ©ç”¨ redis-cli è¿æ¥ 7002ï¼Œæ‰§è¡Œ`get num`ï¼Œå†æ‰§è¡Œ`set num 666`

- åˆ©ç”¨ redis-cli è¿æ¥ 7003ï¼Œæ‰§è¡Œ`get num`ï¼Œå†æ‰§è¡Œ`set num 888`

å¯ä»¥å‘ç°ï¼Œåªæœ‰åœ¨ 7001 è¿™ä¸ª master èŠ‚ç‚¹ä¸Šå¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼Œ7002 å’Œ 7003 è¿™ä¸¤ä¸ª slave èŠ‚ç‚¹åªèƒ½æ‰§è¡Œè¯»æ“ä½œã€‚

# 3.æ­å»ºå“¨å…µé›†ç¾¤

## 3.1.é›†ç¾¤ç»“æ„

è¿™é‡Œæˆ‘ä»¬æ­å»ºä¸€ä¸ªä¸‰èŠ‚ç‚¹å½¢æˆçš„ Sentinel é›†ç¾¤ï¼Œæ¥ç›‘ç®¡ä¹‹å‰çš„ Redis ä¸»ä»é›†ç¾¤ã€‚å¦‚å›¾ï¼š

![image-20210701215227018](./assets/image-20210701215227018.png)

ä¸‰ä¸ª sentinel å®ä¾‹ä¿¡æ¯å¦‚ä¸‹ï¼š

| èŠ‚ç‚¹ |       IP        | PORT  |
| ---- | :-------------: | :---: |
| s1   | 192.168.150.101 | 27001 |
| s2   | 192.168.150.101 | 27002 |
| s3   | 192.168.150.101 | 27003 |

## 3.2.å‡†å¤‡å®ä¾‹å’Œé…ç½®

è¦åœ¨åŒä¸€å°è™šæ‹Ÿæœºå¼€å¯ 3 ä¸ªå®ä¾‹ï¼Œå¿…é¡»å‡†å¤‡ä¸‰ä»½ä¸åŒçš„é…ç½®æ–‡ä»¶å’Œç›®å½•ï¼Œé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¹Ÿå°±æ˜¯å·¥ä½œç›®å½•ã€‚

æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—åˆ†åˆ«å« s1ã€s2ã€s3ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# åˆ›å»ºç›®å½•
mkdir s1 s2 s3
```

å¦‚å›¾ï¼š

![image-20210701215534714](./assets/image-20210701215534714.png)

ç„¶åæˆ‘ä»¬åœ¨ s1 ç›®å½•åˆ›å»ºä¸€ä¸ª sentinel.conf æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š

```ini
port 27001
sentinel announce-ip 192.168.126.129
sentinel monitor mymaster 192.168.126.129 7001 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
dir "/tmp/s1"
```

è§£è¯»ï¼š

- `port 27001`ï¼šæ˜¯å½“å‰ sentinel å®ä¾‹çš„ç«¯å£
- `sentinel monitor mymaster 192.168.150.101 7001 2`ï¼šæŒ‡å®šä¸»èŠ‚ç‚¹ä¿¡æ¯
  - `mymaster`ï¼šä¸»èŠ‚ç‚¹åç§°ï¼Œè‡ªå®šä¹‰ï¼Œä»»æ„å†™
  - `192.168.150.101 7001`ï¼šä¸»èŠ‚ç‚¹çš„ ip å’Œç«¯å£
  - `2`ï¼šé€‰ä¸¾ master æ—¶çš„ quorum å€¼

ç„¶åå°† s1/sentinel.conf æ–‡ä»¶æ‹·è´åˆ° s2ã€s3 ä¸¤ä¸ªç›®å½•ä¸­ï¼ˆåœ¨/tmp ç›®å½•æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼‰ï¼š

```sh
# æ–¹å¼ä¸€ï¼šé€ä¸ªæ‹·è´
cp s1/sentinel.conf s2
cp s1/sentinel.conf s3
# æ–¹å¼äºŒï¼šç®¡é“ç»„åˆå‘½ä»¤ï¼Œä¸€é”®æ‹·è´
echo s2 s3 | xargs -t -n 1 cp s1/sentinel.conf
```

ä¿®æ”¹ s2ã€s3 ä¸¤ä¸ªæ–‡ä»¶å¤¹å†…çš„é…ç½®æ–‡ä»¶ï¼Œå°†ç«¯å£åˆ†åˆ«ä¿®æ”¹ä¸º 27002ã€27003ï¼š

```sh
sed -i -e 's/27001/27002/g' -e 's/s1/s2/g' s2/sentinel.conf
sed -i -e 's/27001/27003/g' -e 's/s1/s3/g' s3/sentinel.conf
```

## 3.3.å¯åŠ¨

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬æ‰“å¼€ 3 ä¸ª ssh çª—å£ï¼Œåˆ†åˆ«å¯åŠ¨ 3 ä¸ª redis å®ä¾‹ï¼Œå¯åŠ¨å‘½ä»¤ï¼š

```sh
# ç¬¬1ä¸ª
redis-sentinel s1/sentinel.conf
# ç¬¬2ä¸ª
redis-sentinel s2/sentinel.conf
# ç¬¬3ä¸ª
redis-sentinel s3/sentinel.conf
```

å¯åŠ¨åï¼š

![image-20210701220714104](./assets/image-20210701220714104.png)

## 3.4.æµ‹è¯•

å°è¯•è®© master èŠ‚ç‚¹ 7001 å®•æœºï¼ŒæŸ¥çœ‹ sentinel æ—¥å¿—ï¼š

![image-20210701222857997](./assets/image-20210701222857997.png)

æŸ¥çœ‹ 7003 çš„æ—¥å¿—ï¼š

![image-20210701223025709](./assets/image-20210701223025709.png)

æŸ¥çœ‹ 7002 çš„æ—¥å¿—ï¼š

![image-20210701223131264](./assets/image-20210701223131264.png)

# 4.æ­å»ºåˆ†ç‰‡é›†ç¾¤

## 4.1.é›†ç¾¤ç»“æ„

åˆ†ç‰‡é›†ç¾¤éœ€è¦çš„èŠ‚ç‚¹æ•°é‡è¾ƒå¤šï¼Œè¿™é‡Œæˆ‘ä»¬æ­å»ºä¸€ä¸ªæœ€å°çš„åˆ†ç‰‡é›†ç¾¤ï¼ŒåŒ…å« 3 ä¸ª master èŠ‚ç‚¹ï¼Œæ¯ä¸ª master åŒ…å«ä¸€ä¸ª slave èŠ‚ç‚¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![image-20210702164116027](./assets/image-20210702164116027.png)

è¿™é‡Œæˆ‘ä»¬ä¼šåœ¨åŒä¸€å°è™šæ‹Ÿæœºä¸­å¼€å¯ 6 ä¸ª redis å®ä¾‹ï¼Œæ¨¡æ‹Ÿåˆ†ç‰‡é›†ç¾¤ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼š

|       IP        | PORT |  è§’è‰²  |
| :-------------: | :--: | :----: |
| 192.168.150.101 | 7001 | master |
| 192.168.150.101 | 7002 | master |
| 192.168.150.101 | 7003 | master |
| 192.168.150.101 | 8001 | slave  |
| 192.168.150.101 | 8002 | slave  |
| 192.168.150.101 | 8003 | slave  |

## 4.2.å‡†å¤‡å®ä¾‹å’Œé…ç½®

åˆ é™¤ä¹‹å‰çš„ 7001ã€7002ã€7003 è¿™å‡ ä¸ªç›®å½•ï¼Œé‡æ–°åˆ›å»ºå‡º 7001ã€7002ã€7003ã€8001ã€8002ã€8003 ç›®å½•ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# åˆ é™¤æ—§çš„ï¼Œé¿å…é…ç½®å¹²æ‰°
rm -rf 7001 7002 7003
# åˆ›å»ºç›®å½•
mkdir 7001 7002 7003 8001 8002 8003
```

åœ¨/tmp ä¸‹å‡†å¤‡ä¸€ä¸ªæ–°çš„ redis.conf æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ini
port 6379
# å¼€å¯é›†ç¾¤åŠŸèƒ½
cluster-enabled yes
# é›†ç¾¤çš„é…ç½®æ–‡ä»¶åç§°ï¼Œä¸éœ€è¦æˆ‘ä»¬åˆ›å»ºï¼Œç”±redisè‡ªå·±ç»´æŠ¤
cluster-config-file /tmp/6379/nodes.conf
# èŠ‚ç‚¹å¿ƒè·³å¤±è´¥çš„è¶…æ—¶æ—¶é—´
cluster-node-timeout 5000
# æŒä¹…åŒ–æ–‡ä»¶å­˜æ”¾ç›®å½•
dir /tmp/6379
# ç»‘å®šåœ°å€
bind 0.0.0.0
# è®©redisåå°è¿è¡Œ
daemonize yes
# æ³¨å†Œçš„å®ä¾‹ip
replica-announce-ip 192.168.150.101
# ä¿æŠ¤æ¨¡å¼
protected-mode no
# æ•°æ®åº“æ•°é‡
databases 1
# æ—¥å¿—
logfile /tmp/6379/run.log
```

å°†è¿™ä¸ªæ–‡ä»¶æ‹·è´åˆ°æ¯ä¸ªç›®å½•ä¸‹ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# æ‰§è¡Œæ‹·è´
echo 7001 7002 7003 8001 8002 8003 | xargs -t -n 1 cp redis.conf
```

ä¿®æ”¹æ¯ä¸ªç›®å½•ä¸‹çš„ redis.confï¼Œå°†å…¶ä¸­çš„ 6379 ä¿®æ”¹ä¸ºä¸æ‰€åœ¨ç›®å½•ä¸€è‡´ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# ä¿®æ”¹é…ç½®æ–‡ä»¶
printf '%s\n' 7001 7002 7003 8001 8002 8003 | xargs -I{} -t sed -i 's/6379/{}/g' {}/redis.conf
```

## 4.3.å¯åŠ¨

å› ä¸ºå·²ç»é…ç½®äº†åå°å¯åŠ¨æ¨¡å¼ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¯åŠ¨æœåŠ¡ï¼š

```sh
# è¿›å…¥/tmpç›®å½•
cd /tmp
# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
printf '%s\n' 7001 7002 7003 8001 8002 8003 | xargs -I{} -t redis-server {}/redis.conf
```

é€šè¿‡ ps æŸ¥çœ‹çŠ¶æ€ï¼š

```sh
ps -ef | grep redis
```

å‘ç°æœåŠ¡éƒ½å·²ç»æ­£å¸¸å¯åŠ¨ï¼š

![image-20210702174255799](./assets/image-20210702174255799.png)

å¦‚æœè¦å…³é—­æ‰€æœ‰è¿›ç¨‹ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š

```sh
ps -ef | grep redis | awk '{print $2}' | xargs kill
```

æˆ–è€…ï¼ˆæ¨èè¿™ç§æ–¹å¼ï¼‰ï¼š

```sh
printf '%s\n' 7001 7002 7003 8001 8002 8003 | xargs -I{} -t redis-cli -p {} shutdown
```

## 4.4.åˆ›å»ºé›†ç¾¤

è™½ç„¶æœåŠ¡å¯åŠ¨äº†ï¼Œä½†æ˜¯ç›®å‰æ¯ä¸ªæœåŠ¡ä¹‹é—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰ä»»ä½•å…³è”ã€‚

æˆ‘ä»¬éœ€è¦æ‰§è¡Œå‘½ä»¤æ¥åˆ›å»ºé›†ç¾¤ï¼Œåœ¨ Redis5.0 ä¹‹å‰åˆ›å»ºé›†ç¾¤æ¯”è¾ƒéº»çƒ¦ï¼Œ5.0 ä¹‹åé›†ç¾¤ç®¡ç†å‘½ä»¤éƒ½é›†æˆåˆ°äº† redis-cli ä¸­ã€‚

1ï¼‰Redis5.0 ä¹‹å‰

Redis5.0 ä¹‹å‰é›†ç¾¤å‘½ä»¤éƒ½æ˜¯ç”¨ redis å®‰è£…åŒ…ä¸‹çš„ src/redis-trib.rb æ¥å®ç°çš„ã€‚å› ä¸º redis-trib.rb æ˜¯æœ‰ ruby è¯­è¨€ç¼–å†™çš„æ‰€ä»¥éœ€è¦å®‰è£… ruby ç¯å¢ƒã€‚

```sh
# å®‰è£…ä¾èµ–
yum -y install zlib ruby rubygems
gem install redis
```

ç„¶åé€šè¿‡å‘½ä»¤æ¥ç®¡ç†é›†ç¾¤ï¼š

```sh
# è¿›å…¥redisçš„srcç›®å½•
cd /tmp/redis-6.2.4/src
# åˆ›å»ºé›†ç¾¤
./redis-trib.rb create --replicas 1 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003
```

2ï¼‰Redis5.0 ä»¥å

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Redis6.2.4 ç‰ˆæœ¬ï¼Œé›†ç¾¤ç®¡ç†ä»¥åŠé›†æˆåˆ°äº† redis-cli ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```sh
redis-cli --cluster create --cluster-replicas 1 192.168.126.129:7001 192.168.126.129:7002 192.168.126.129:7003 192.168.126.129:8001 192.168.126.129:8002  192.168.126.129:8003
```

å‘½ä»¤è¯´æ˜ï¼š

- `redis-cli --cluster`æˆ–è€…`./redis-trib.rb`ï¼šä»£è¡¨é›†ç¾¤æ“ä½œå‘½ä»¤
- `create`ï¼šä»£è¡¨æ˜¯åˆ›å»ºé›†ç¾¤
- `--replicas 1`æˆ–è€…`--cluster-replicas 1` ï¼šæŒ‡å®šé›†ç¾¤ä¸­æ¯ä¸ª master çš„å‰¯æœ¬ä¸ªæ•°ä¸º 1ï¼Œæ­¤æ—¶`èŠ‚ç‚¹æ€»æ•° Ã· (replicas + 1)` å¾—åˆ°çš„å°±æ˜¯ master çš„æ•°é‡ã€‚å› æ­¤èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„å‰ n ä¸ªå°±æ˜¯ masterï¼Œå…¶å®ƒèŠ‚ç‚¹éƒ½æ˜¯ slave èŠ‚ç‚¹ï¼Œéšæœºåˆ†é…åˆ°ä¸åŒ master

è¿è¡Œåçš„æ ·å­ï¼š

![image-20210702181101969](./assets/image-20210702181101969.png)

è¿™é‡Œè¾“å…¥ yesï¼Œåˆ™é›†ç¾¤å¼€å§‹åˆ›å»ºï¼š

![image-20210702181215705](./assets/image-20210702181215705.png)

é€šè¿‡å‘½ä»¤å¯ä»¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š

```sh
redis-cli -p 7001 cluster nodes
```

![image-20210702181922809](./assets/image-20210702181922809.png)

## 4.5.æµ‹è¯•

å°è¯•è¿æ¥ 7001 èŠ‚ç‚¹ï¼Œå­˜å‚¨ä¸€ä¸ªæ•°æ®ï¼š

```sh
# è¿æ¥
redis-cli -p 7001
# å­˜å‚¨æ•°æ®
set num 123
# è¯»å–æ•°æ®
get num
# å†æ¬¡å­˜å‚¨
set a 1
```

ç»“æœæ‚²å‰§äº†ï¼š

![image-20210702182343979](./assets/image-20210702182343979.png)

é›†ç¾¤æ“ä½œæ—¶ï¼Œéœ€è¦ç»™`redis-cli`åŠ ä¸Š`-c`å‚æ•°æ‰å¯ä»¥ï¼š

```sh
redis-cli -c -p 7001
```

è¿™æ¬¡å¯ä»¥äº†ï¼š

![image-20210702182602145](./assets/image-20210702182602145.png)
